name: Electron Release

# å†™å…¥ GitHub Release çš„æƒé™
permissions:
  contents: write

# å½“ä½ æ¨é€ä¸€ä¸ªä»¥ 'v' å¼€å¤´çš„ tag æ—¶è§¦å‘ (ä¾‹å¦‚ v1.0.0, v2.3.1)
on:
  push:
    tags:
      - 'v*'

jobs:
  # -------------------------------------------------------------------
  # ä»»åŠ¡ 0: è®¾ç½®å…¨å±€å˜é‡
  # -------------------------------------------------------------------
  setup:
    name: âš™ï¸ Setup Global Variables
    runs-on: ubuntu-latest
    outputs:
      product_name: ${{ steps.vars.outputs.product_name }}
      app_version: ${{ steps.vars.outputs.app_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ä» package.json ä¸­è¯»å– productName å’Œ version
      - name: Extract variables from package.json
        id: vars
        shell: bash
        run: |
          # ä½¿ç”¨ jq å·¥å…·è§£æ JSON æ–‡ä»¶
          # strip_quotes å‡½æ•°ç”¨äºç§»é™¤å­—ç¬¦ä¸²ä¸¤è¾¹çš„å¼•å·
          strip_quotes() {
            local input="$1"
            # ç§»é™¤å¼€å¤´å’Œç»“å°¾çš„å¼•å·
            input="${input#\"}"
            input="${input%\"}"
            echo "$input"
          }
          
          # æå– version (ä¾‹å¦‚ "1.2.3")
          APP_VERSION=$(jq '.version' package.json | xargs)
          
          # æå– productNameã€‚æ³¨æ„ï¼šjq é»˜è®¤ä¼šå¸¦å¼•å·è¾“å‡ºï¼Œéœ€è¦ç§»é™¤
          PRODUCT_NAME=$(strip_quotes "$(jq '.build.productName' package.json)")
          
          echo "product_name=$PRODUCT_NAME" >> $GITHUB_OUTPUT
          echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT

  # -------------------------------------------------------------------
  # ä»»åŠ¡ 1: ç”Ÿæˆå‘å¸ƒè¯´æ˜
  # -------------------------------------------------------------------
  generate-release-notes:
    name: ğŸ“œ Generate Release Notes
    runs-on: ubuntu-latest
    outputs:
      release_notes: ${{ steps.generate_release_notes.outputs.release_notes }}
      current_tag: ${{ steps.get_tags.outputs.current_tag }}
    steps:
      # æ£€å‡ºä»£ç ï¼Œfetch-depth: 0 è¡¨ç¤ºè·å–æ‰€æœ‰å†å²è®°å½•ï¼Œä»¥ä¾¿è¯»å– git log
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # è·å–å½“å‰å’Œä¸Šä¸€ä¸ªæ ‡ç­¾ï¼Œç”¨äºç¡®å®š commit èŒƒå›´
      - name: Get current and previous tags
        id: get_tags
        run: |
          tags=($(git tag -l --sort=-version:refname))
          current_tag=${tags[0]}
          # å¦‚æœåªæœ‰ä¸€ä¸ª tagï¼Œå°±å°†ä¸Šä¸€ä¸ª tag è®¾ä¸ºç©º
          previous_tag=${tags[1]:-$(git rev-list --max-parents=0 HEAD)}
          echo "previous_tag=$previous_tag" >> $GITHUB_OUTPUT
          echo "current_tag=$current_tag" >> $GITHUB_OUTPUT

      # æå–å¹¶åˆ†ç±» commit ä¿¡æ¯ï¼Œç”Ÿæˆ Markdown æ ¼å¼çš„å‘å¸ƒè¯´æ˜
      - name: Generate Release Notes from Commits
        id: generate_release_notes
        run: |
          # å‡½æ•°: ç”¨äºæ ¼å¼åŒ–æ¯ä¸ªåˆ†ç±»çš„ commit
          format_messages() {
            local title="$1"
            local messages="$2"
            local output=""
            if [[ -n "$messages" ]]; then
              output+="\n### $title\n"
              output+=$(echo "$messages" | awk '{print "- " $0}')
            fi
            echo -e "$output"
          }

          # è·å–ä¸¤ä¸ª tag ä¹‹é—´çš„ commit log
          COMMIT_LOGS=$(git log --pretty=format:"%s - by @%an (%h)" ${{ steps.get_tags.outputs.previous_tag }}..${{ steps.get_tags.outputs.current_tag }})

          # æŒ‰ç±»å‹ç­›é€‰ commit
          FEAT_MESSAGES=$(echo "$COMMIT_LOGS" | grep -E '^feat' || true)
          FIX_MESSAGES=$(echo "$COMMIT_LOGS" | grep -E '^fix' || true)
          DOCS_MESSAGES=$(echo "$COMMIT_LOGS" | grep -E '^docs' || true)
          PERF_MESSAGES=$(echo "$COMMIT_LOGS" | grep -E '^perf' || true)
          CHORE_MESSAGES=$(echo "$COMMIT_LOGS" | grep -E '^chore' || true)

          # ç»„åˆæˆå®Œæ•´çš„å‘å¸ƒè¯´æ˜
          RELEASE_NOTES=""
          RELEASE_NOTES+=$(format_messages "ğŸš€ Features (æ–°åŠŸèƒ½)" "$FEAT_MESSAGES")
          RELEASE_NOTES+=$(format_messages "ğŸ©¹ Fixes (ç¼ºé™·ä¿®å¤)" "$FIX_MESSAGES")
          RELEASE_NOTES+=$(format_messages "ğŸ“– Documentation (æ–‡æ¡£)" "$DOCS_MESSAGES")
          RELEASE_NOTES+=$(format_messages "ğŸ”¥ Performance (æ€§èƒ½ä¼˜åŒ–)" "$PERF_MESSAGES")
          RELEASE_NOTES+=$(format_messages "ğŸ§¹ Chores (æ‚é¡¹)" "$CHORE_MESSAGES")

          # ä½¿ç”¨ EOF æ¥å¤„ç†å¤šè¡Œæ–‡æœ¬ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸º GitHub Action çš„è¾“å‡º
          {
            echo 'release_notes<<EOF'
            echo -e "$RELEASE_NOTES"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

  # -------------------------------------------------------------------
  # ä»»åŠ¡ 2: å¹¶è¡Œæ„å»º
  # -------------------------------------------------------------------
  build:
    name: ğŸ’» Build on ${{ matrix.os }}
    needs: [setup, generate-release-notes] # ç­‰å¾…ä¹‹å‰ä»»åŠ¡å®Œæˆ
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # åœ¨è¿™ä¸‰ä¸ªæ“ä½œç³»ç»Ÿä¸Šå¹¶è¡Œè¿è¡Œ
        os: [macos-latest, ubuntu-latest, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20 # Node.js ç‰ˆæœ¬
          cache: pnpm # ç¼“å­˜ pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # æ‰§è¡Œæ„å»ºå‘½ä»¤ï¼Œelectron-builder ä¼šè‡ªåŠ¨è¯†åˆ«å½“å‰ç³»ç»Ÿå¹¶æ‰“åŒ…
      - name: Build Electron app
        run: pnpm run build

      # --- ä½¿ç”¨å…¨å±€å˜é‡æ¥å‘½åå‹ç¼©åŒ… ---
      - name: Compress Portable/Unpacked Directories
        shell: bash
        run: |
          # ä» needs ä¸Šä¸‹æ–‡ä¸­è·å–å˜é‡
          PRODUCT_NAME="${{ needs.setup.outputs.product_name }}"
          APP_VERSION="${{ needs.setup.outputs.app_version }}"

          if [[ "${{ runner.os }}" == "Windows" ]]; then
            if [ -d "release/win-unpacked" ]; then
              powershell -Command "Compress-Archive -Path release/win-unpacked -DestinationPath release/${PRODUCT_NAME}-${APP_VERSION}-portable-win.zip"
            fi
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            if [ -d "release/mac" ]; then
              zip -r "release/${PRODUCT_NAME}-${APP_VERSION}-portable-mac-x64.zip" release/mac
            fi
            if [ -d "release/mac-arm64" ]; then
              zip -r "release/${PRODUCT_NAME}-${APP_VERSION}-portable-mac-arm64.zip" release/mac-arm64
            fi
          else # Linux
            if [ -d "release/linux-unpacked" ]; then
              zip -r "release/${PRODUCT_NAME}-${APP_VERSION}-portable-linux.zip" release/linux-unpacked
            fi
          fi

      # ä¸Šä¼ æ„å»ºäº§ç‰©ï¼Œä¸º release ä»»åŠ¡åšå‡†å¤‡
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.setup.outputs.product_name }}-${{ matrix.os }} # ç”¨ç³»ç»ŸååŒºåˆ†äº§ç‰©
          path: |
            release/demo_?.?.?.dmg*
            release/demo_?.?.?.exe*
            release/demo_?.?.?.AppImage
            release/demo_?.?.?.snap
            release/*.zip

  # -------------------------------------------------------------------
  # ä»»åŠ¡ 3: åˆ›å»º GitHub Release
  # -------------------------------------------------------------------
  release:
    name: ğŸ“¦ Create GitHub Release
    needs: [setup, generate-release-notes, build] # ç­‰å¾…ç¬”è®°ç”Ÿæˆå’Œæ‰€æœ‰æ„å»ºä»»åŠ¡å®Œæˆ
    runs-on: ubuntu-latest

    steps:
      # ä¸‹è½½æ‰€æœ‰ç”± build ä»»åŠ¡ä¸Šä¼ çš„æ„å»ºäº§ç‰©
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts # ä¸‹è½½åˆ° artifacts ç›®å½•

      # ä½¿ç”¨ ncipollo/release-action åˆ›å»º Release
      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          name: ${{ needs.setup.outputs.product_name }} v${{ needs.setup.outputs.app_version }}
          # ä»ä¸‹è½½çš„äº§ç‰©ä¸­åŒ¹é…æ‰€æœ‰æ–‡ä»¶å¹¶ä¸Šä¼ 
          # 'artifacts/*/*' æ¨¡å¼ä¼šåŒ¹é…å¦‚ artifacts/electron-app-macos-latest/MyApp.dmg è¿™æ ·çš„æ–‡ä»¶
          artifacts: "artifacts/*/*"
          # ä» generate-release-notes ä»»åŠ¡è·å–å‘å¸ƒè¯´æ˜
          body: ${{ needs.generate-release-notes.outputs.release_notes }}
          # ä» generate-release-notes ä»»åŠ¡è·å– tag
          tag: ${{ needs.generate-release-notes.outputs.current_tag }}
          # è‡ªåŠ¨ç”Ÿæˆçš„ release é»˜è®¤ä¸ºé¢„å‘å¸ƒï¼Œä½ å¯ä»¥åœ¨ GitHub ä¸Šæ‰‹åŠ¨è®¾ä¸ºæ­£å¼ç‰ˆ
          prerelease: true
          # GITHUB_TOKEN æ˜¯ç”± GitHub Actions è‡ªåŠ¨æä¾›çš„
          token: ${{ secrets.GITHUB_TOKEN }}
